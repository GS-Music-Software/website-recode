---
import { Github } from "@lucide/astro";
---

<section class="relative overflow-hidden">
  <div class="pointer-events-none absolute inset-0 flex items-start justify-center" aria-hidden="true">
    <div class="relative flex h-max w-max items-center justify-center opacity-50" style="filter: blur(120px); animation: spin-slow 20s linear infinite;">
      <div class="absolute h-[40rem] w-[40rem] rounded-full bg-rose-600" style="transform: translate(-20%, 0)"></div>
      <div class="absolute h-[40rem] w-[40rem] rounded-full bg-primary" style="transform: translate(10%, -35%)"></div>
      <div class="absolute h-[40rem] w-[40rem] rounded-full bg-rose-800" style="transform: translate(10%, 35%)"></div>
    </div>
  </div>

  <div class="relative z-10 mx-auto flex max-w-[1300px] flex-col items-center px-4 pt-28 pb-20 text-center sm:px-8 lg:px-16 lg:pt-32">
    <a id="release-badge" href="#" target="_blank" rel="noopener noreferrer" class="mb-6 inline-flex items-center gap-2 rounded-full border border-border bg-surface/60 px-4 py-1.5 text-sm text-muted transition-colors duration-200 hover:text-foreground">
      <span id="release-label" class="text-foreground">New Release: GS Music</span>
      <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
    </a>
    <h1 class="mb-5 max-w-[700px] text-4xl font-extrabold tracking-tight lg:text-5xl xl:text-6xl">
      The music player<br />you deserve.
    </h1>

    <p class="mx-auto max-w-[560px] text-lg text-muted lg:text-xl">
      An open source, free music player with a plethora of features built right in.
    </p>

    <div class="mt-10 flex items-center gap-3">
      <button
        id="download-btn"
        class="rounded-md bg-primary px-5 py-2.5 text-sm font-semibold text-white cursor-pointer"
      >
        Download
      </button>
      <a
        href="https://github.com/GS-Music-Software/desktop-recode"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center gap-2 px-4 py-2.5 text-sm font-medium text-muted transition-colors duration-200 hover:text-foreground"
      >
        <Github class="h-4 w-4" />
        Source Code
      </a>
    </div>

    <div class="carousel" id="carousel">
      <div class="carousel-track">
        <div class="carousel-slide" data-index="0">
          <div class="slide-clip"><img src="/app-screenshot.png" alt="GS Music" /></div>
        </div>
        <div class="carousel-slide" data-index="1">
          <div class="slide-clip"><img src="/screenshot-2.png" alt="GS Music" /></div>
        </div>
        <div class="carousel-slide" data-index="2">
          <div class="slide-clip"><img src="/screenshot-3.png" alt="GS Music" /></div>
        </div>
      </div>
      <div class="carousel-dots">
        <button class="carousel-dot active" data-index="0" aria-label="Slide 1"></button>
        <button class="carousel-dot" data-index="1" aria-label="Slide 2"></button>
        <button class="carousel-dot" data-index="2" aria-label="Slide 3"></button>
      </div>
    </div>

  </div>
</section>

<style>
  .carousel {
    position: relative;
    width: 100%;
    max-width: 1200px;
    height: 580px;
    margin-top: 0.5rem;
    perspective: 1200px;
    user-select: none;
  }

  .carousel-track {
    position: relative;
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
  }

  .carousel-slide {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 75%;
    transform: translate(-50%, -50%) scale(0.7);
    opacity: 0;
    transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1),
                opacity 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    pointer-events: none;
    z-index: 0;
  }

  .slide-clip {
    border-radius: 16px;
    overflow: hidden;
    isolation: isolate;
  }

  .carousel-slide img {
    width: 100%;
    display: block;
    filter: blur(10px) brightness(0.35);
    transform: scale(1.08);
    transition: filter 0.6s cubic-bezier(0.23, 1, 0.32, 1),
                transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
  }

  .carousel-slide[data-pos="center"] {
    transform: translate(-50%, -50%) scale(1) rotateY(0deg);
    opacity: 1;
    z-index: 3;
    pointer-events: auto;
    cursor: pointer;
  }

  .carousel-slide[data-pos="center"] .slide-clip {
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
  }

  .carousel-slide[data-pos="center"] img {
    filter: blur(0) brightness(1);
    transform: scale(1);
  }

  .carousel-slide[data-pos="left"] {
    transform: translate(-105%, -50%) scale(0.65) rotateY(10deg);
    opacity: 0.3;
    z-index: 1;
    pointer-events: auto;
    cursor: pointer;
  }

  .carousel-slide[data-pos="right"] {
    transform: translate(5%, -50%) scale(0.65) rotateY(-10deg);
    opacity: 0.3;
    z-index: 1;
    pointer-events: auto;
    cursor: pointer;
  }

  .carousel-slide[data-pos="far-left"] {
    transform: translate(-140%, -50%) scale(0.5) rotateY(16deg);
    opacity: 0;
    z-index: 0;
  }

  .carousel-slide[data-pos="far-right"] {
    transform: translate(40%, -50%) scale(0.5) rotateY(-16deg);
    opacity: 0;
    z-index: 0;
  }

  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 20px;
  }

  .carousel-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
    border: none;
    cursor: pointer;
    padding: 0;
    transition: all 0.3s ease;
  }

  .carousel-dot.active {
    background: var(--color-primary);
    box-shadow: 0 0 8px rgba(252, 60, 68, 0.4);
  }

  @media (max-width: 768px) {
    .carousel {
      height: 300px;
      margin-top: 0.5rem;
    }

    .carousel-slide {
      width: 85%;
    }

    .carousel-slide[data-pos="left"] {
      transform: translate(-100%, -50%) scale(0.6) rotateY(8deg);
    }

    .carousel-slide[data-pos="right"] {
      transform: translate(0%, -50%) scale(0.6) rotateY(-8deg);
    }
  }

  @media (min-width: 1024px) {
    .carousel {
      margin-top: 0.5rem;
      height: 650px;
    }
  }
</style>

<div id="download-modal" class="fixed inset-0 z-50 hidden items-center justify-center" style="backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
  <div id="download-panel" class="relative mx-4 w-full max-w-[400px] overflow-hidden rounded-2xl border border-border" style="opacity: 0; transform: scale(0.92) translateY(16px); transition: opacity 0.2s cubic-bezier(0.16, 1, 0.3, 1), transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); background: rgba(28, 25, 23, 0.7); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);">
    <div class="pointer-events-none absolute inset-0 overflow-hidden rounded-2xl">
      <div class="absolute -top-20 -right-20 h-40 w-40 rounded-full bg-primary opacity-[0.07]" style="filter: blur(60px);"></div>
    </div>

    <div id="platform-view" class="relative" style="transition: opacity 0.2s ease, transform 0.2s ease;">
      <div class="px-6 pt-6 pb-5">
        <h3 class="text-lg font-semibold text-foreground">Download GS Music</h3>
        <p class="mt-1 text-sm text-muted">Choose your platform</p>
      </div>

      <div class="flex flex-col gap-3 px-6 pb-3">
        <a id="linux-dl" href="#" class="flex items-center gap-4 rounded-xl border border-border bg-background px-5 py-4">
          <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-foreground/[0.06]">
            <svg class="h-5 w-5 text-foreground" viewBox="0 0 24 24" fill="currentColor"><path d="M12.504 0c-.155 0-.315.008-.48.021-4.226.333-3.105 4.807-3.17 6.298-.076 1.092-.3 1.953-1.05 3.02-.885 1.051-2.127 2.75-2.716 4.521-.278.832-.41 1.684-.287 2.489a.424.424 0 0 0-.11.135c-.26.268-.45.6-.663.839-.199.199-.485.267-.797.4-.313.136-.658.269-.864.68-.09.189-.136.394-.132.602 0 .199.027.4.055.536.058.399.116.728.04.97-.249.68-.28 1.145-.106 1.484.174.334.535.47.94.601.81.2 1.91.135 2.774.6.926.466 1.866.67 2.616.47.526-.116.97-.464 1.208-.946.587-.003 1.23-.269 2.26-.334.699-.058 1.574.267 2.577.2.025.134.063.198.114.333l.003.003c.391.778 1.113 1.132 1.884 1.071.771-.06 1.592-.536 2.257-1.306.631-.765 1.683-1.084 2.378-1.503.348-.199.629-.469.649-.853.023-.4-.2-.811-.714-1.376v-.097l-.003-.003c-.17-.2-.25-.535-.338-.926-.085-.401-.182-.786-.492-1.046h-.003c-.059-.054-.123-.067-.188-.135a.357.357 0 0 0-.19-.064c.431-1.278.264-2.55-.173-3.694-.533-1.41-1.465-2.638-2.175-3.483-.796-1.005-1.576-1.957-1.56-3.368.026-2.152.236-6.133-3.544-6.139z"/></svg>
          </div>
          <div class="flex flex-col">
            <span class="text-[15px] font-semibold text-foreground">Linux</span>
            <span class="text-[13px] text-muted">Executable installer</span>
          </div>
          <svg class="ml-auto h-4 w-4 text-faint" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        </a>

        <a id="windows-dl" href="#" class="flex items-center gap-4 rounded-xl border border-border bg-background px-5 py-4">
          <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-foreground/[0.06]">
            <svg class="h-5 w-5 text-foreground" viewBox="0 0 88 88" fill="currentColor"><path d="M0 12.402l35.687-4.86.016 34.423-35.67.203zm35.67 33.529l.028 34.453L.028 71.48l-.026-25.55zm4.326-39.025L87.314 0v41.527l-47.318.376zm47.329 39.349l-.011 41.34-47.318-6.678-.066-34.739z"/></svg>
          </div>
          <div class="flex flex-col">
            <span class="text-[15px] font-semibold text-foreground">Windows</span>
            <span class="text-[13px] text-muted">Executable installer</span>
          </div>
          <svg class="ml-auto h-4 w-4 text-faint" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        </a>
      </div>

      <div class="px-6 pt-1 pb-5">
        <button id="download-close" class="w-full rounded-xl py-2.5 text-sm font-medium text-subtle transition-colors duration-150 hover:text-foreground cursor-pointer">
          Cancel
        </button>
      </div>
    </div>

  </div>
</div>

<script>
  const btn = document.getElementById("download-btn");
  const modal = document.getElementById("download-modal");
  const panel = document.getElementById("download-panel");
  const close_btn = document.getElementById("download-close");
  const linux_dl = document.getElementById("linux-dl") as HTMLAnchorElement;
  const windows_dl = document.getElementById("windows-dl") as HTMLAnchorElement;
  const release_badge = document.getElementById("release-badge") as HTMLAnchorElement;
  const release_label = document.getElementById("release-label");

  const installer_api = "https://api.github.com/repos/GS-Music-Software/recode-installer/releases/latest";
  const app_api = "https://api.github.com/repos/GS-Music-Software/desktop-recode/releases/latest";

  fetch(installer_api)
    .then((r) => r.json())
    .then((release: any) => {
      for (const asset of release.assets) {
        if (asset.name.startsWith("gs-music-installer_linux")) {
          linux_dl.href = asset.browser_download_url;
        }
        if (asset.name.startsWith("gs-music-installer_windows") && asset.name.endsWith(".exe")) {
          windows_dl.href = asset.browser_download_url;
        }
      }
    })
    .catch((e) => console.error("failed to fetch installer releases:", e));

  fetch(app_api)
    .then((r) => r.json())
    .then((release: any) => {
      if (release.tag_name && release.html_url) {
        if (release_label) release_label.textContent = `New Release: GS Music ${release.tag_name}`;
        release_badge.href = release.html_url;
      }
    })
    .catch((e) => console.error("failed to fetch app releases:", e));

  const show_panel = () => {
    modal?.classList.remove("hidden");
    modal?.classList.add("flex");
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        if (panel) {
          panel.style.opacity = "1";
          panel.style.transform = "scale(1) translateY(0)";
        }
      });
    });
  };

  const hide = () => {
    if (panel) {
      panel.style.opacity = "0";
      panel.style.transform = "scale(0.92) translateY(16px)";
    }
    setTimeout(() => {
      modal?.classList.add("hidden");
      modal?.classList.remove("flex");
    }, 250);
  };

  btn?.addEventListener("click", show_panel);
  close_btn?.addEventListener("click", hide);
  modal?.addEventListener("click", (e) => {
    if (e.target === modal) hide();
  });
</script>

<script>
  const slides = document.querySelectorAll<HTMLElement>(".carousel-slide");
  const dots = document.querySelectorAll<HTMLElement>(".carousel-dot");
  const total = slides.length;
  let current = 0;
  let timer: ReturnType<typeof setInterval>;

  function set_positions() {
    slides.forEach((s) => s.removeAttribute("data-pos"));
    dots.forEach((d) => d.classList.remove("active"));
    const left = (current - 1 + total) % total;
    const right = (current + 1) % total;
    slides[left].setAttribute("data-pos", "left");
    slides[current].setAttribute("data-pos", "center");
    slides[right].setAttribute("data-pos", "right");
    dots[current].classList.add("active");
  }

  function go_to(idx: number) {
    current = ((idx % total) + total) % total;
    set_positions();
    reset_timer();
  }

  function reset_timer() {
    clearInterval(timer);
    timer = setInterval(() => go_to(current + 1), 5000);
  }

  slides.forEach((s) => {
    s.addEventListener("click", () => {
      const pos = s.getAttribute("data-pos");
      if (pos === "center") go_to(current + 1);
      else if (pos === "left") go_to(current - 1);
      else if (pos === "right") go_to(current + 1);
    });
  });

  dots.forEach((d, i) => {
    d.addEventListener("click", () => go_to(i));
  });

  set_positions();
  reset_timer();
</script>
